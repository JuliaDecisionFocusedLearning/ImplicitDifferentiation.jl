<!DOCTYPE html>
<html lang="en"><head><meta charset="UTF-8"/><meta name="viewport" content="width=device-width, initial-scale=1.0"/><title>Unconstrained optimization · ImplicitDifferentiation.jl</title><script data-outdated-warner src="../../assets/warner.js"></script><link rel="canonical" href="https://gdalle.github.io/ImplicitDifferentiation.jl/examples/1_unconstrained_optim/"/><link href="https://cdnjs.cloudflare.com/ajax/libs/lato-font/3.0.0/css/lato-font.min.css" rel="stylesheet" type="text/css"/><link href="https://cdnjs.cloudflare.com/ajax/libs/juliamono/0.045/juliamono.min.css" rel="stylesheet" type="text/css"/><link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.15.4/css/fontawesome.min.css" rel="stylesheet" type="text/css"/><link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.15.4/css/solid.min.css" rel="stylesheet" type="text/css"/><link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.15.4/css/brands.min.css" rel="stylesheet" type="text/css"/><link href="https://cdnjs.cloudflare.com/ajax/libs/KaTeX/0.13.24/katex.min.css" rel="stylesheet" type="text/css"/><script>documenterBaseURL="../.."</script><script src="https://cdnjs.cloudflare.com/ajax/libs/require.js/2.3.6/require.min.js" data-main="../../assets/documenter.js"></script><script src="../../siteinfo.js"></script><script src="../../../versions.js"></script><link class="docs-theme-link" rel="stylesheet" type="text/css" href="../../assets/themes/documenter-dark.css" data-theme-name="documenter-dark" data-theme-primary-dark/><link class="docs-theme-link" rel="stylesheet" type="text/css" href="../../assets/themes/documenter-light.css" data-theme-name="documenter-light" data-theme-primary/><script src="../../assets/themeswap.js"></script></head><body><div id="documenter"><nav class="docs-sidebar"><div class="docs-package-name"><span class="docs-autofit"><a href="../../">ImplicitDifferentiation.jl</a></span></div><form class="docs-search" action="../../search/"><input class="docs-search-query" id="documenter-search-query" name="q" type="text" placeholder="Search docs"/></form><ul class="docs-menu"><li><a class="tocitem" href="../../">Home</a></li><li><a class="tocitem" href="../../api/">API reference</a></li><li><span class="tocitem">Examples</span><ul><li><a class="tocitem" href="../0_basic/">Basic use</a></li><li class="is-active"><a class="tocitem" href>Unconstrained optimization</a><ul class="internal"><li><a class="tocitem" href="#Implicit-function"><span>Implicit function</span></a></li><li><a class="tocitem" href="#Forward-mode-autodiff"><span>Forward mode autodiff</span></a></li><li><a class="tocitem" href="#Reverse-mode-autodiff"><span>Reverse mode autodiff</span></a></li></ul></li><li><a class="tocitem" href="../2_nonlinear_solve/">Nonlinear solve</a></li><li><a class="tocitem" href="../3_fixed_points/">Fixed point</a></li><li><a class="tocitem" href="../4_constrained_optim/">Constrained optimization</a></li><li><a class="tocitem" href="../5_multiargs/">Multiple arguments</a></li></ul></li><li><a class="tocitem" href="../../faq/">FAQ</a></li></ul><div class="docs-version-selector field has-addons"><div class="control"><span class="docs-label button is-static is-size-7">Version</span></div><div class="docs-selector control is-expanded"><div class="select is-fullwidth is-size-7"><select id="documenter-version-selector"></select></div></div></div></nav><div class="docs-main"><header class="docs-navbar"><nav class="breadcrumb"><ul class="is-hidden-mobile"><li><a class="is-disabled">Examples</a></li><li class="is-active"><a href>Unconstrained optimization</a></li></ul><ul class="is-hidden-tablet"><li class="is-active"><a href>Unconstrained optimization</a></li></ul></nav><div class="docs-right"><a class="docs-edit-link" href="https://github.com/gdalle/ImplicitDifferentiation.jl/blob/main/examples/1_unconstrained_optim.jl" title="View on GitHub"><span class="docs-icon fab"></span><span class="docs-label is-hidden-touch">View on GitHub</span></a><a class="docs-settings-button fas fa-cog" id="documenter-settings-button" href="#" title="Settings"></a><a class="docs-sidebar-button fa fa-bars is-hidden-desktop" id="documenter-sidebar-button" href="#"></a></div></header><article class="content" id="documenter-page"><h1 id="Unconstrained-optimization"><a class="docs-heading-anchor" href="#Unconstrained-optimization">Unconstrained optimization</a><a id="Unconstrained-optimization-1"></a><a class="docs-heading-anchor-permalink" href="#Unconstrained-optimization" title="Permalink"></a></h1><p>In this example, we show how to differentiate through the solution of an unconstrained optimization problem:</p><p class="math-container">\[y(x) = \underset{y \in \mathbb{R}^m}{\mathrm{argmin}} ~ f(x, y)\]</p><p>The optimality conditions are given by gradient stationarity:</p><p class="math-container">\[\nabla_2 f(x, y) = 0\]</p><pre><code class="language-julia hljs">using ForwardDiff
using ImplicitDifferentiation
using LinearAlgebra
using Optim
using Random
using Zygote

Random.seed!(63);</code></pre><h2 id="Implicit-function"><a class="docs-heading-anchor" href="#Implicit-function">Implicit function</a><a id="Implicit-function-1"></a><a class="docs-heading-anchor-permalink" href="#Implicit-function" title="Permalink"></a></h2><p>To make verification easy, we minimize the following objective:</p><p class="math-container">\[f(x, y) = \lVert y \odot y - x \rVert^2\]</p><p>In this case, the optimization problem boils down to the componentwise square root function, but we implement it using a black box solver from <a href="https://github.com/JuliaNLSolvers/Optim.jl">Optim.jl</a>. Note the presence of a keyword argument.</p><pre><code class="language-julia hljs">function mysqrt_optim(x; method)
    f(y) = sum(abs2, y .^ 2 .- x)
    y0 = ones(eltype(x), size(x))
    result = optimize(f, y0, method)
    return Optim.minimizer(result)
end</code></pre><pre class="documenter-example-output"><code class="nohighlight hljs ansi">mysqrt_optim (generic function with 1 method)</code></pre><p>First, we create the forward pass which returns the solution <span>$y(x)$</span>. Remember that it should also return additional information <span>$z(x)$</span>, which is useless here.</p><pre><code class="language-julia hljs">function forward_optim(x; method)
    y = mysqrt_optim(x; method)
    z = 0
    return y, z
end</code></pre><pre class="documenter-example-output"><code class="nohighlight hljs ansi">forward_optim (generic function with 1 method)</code></pre><p>Even though they are defined as a gradient, it is better to provide optimality conditions explicitly: that way we avoid nesting autodiff calls. Remember, the conditions should accept three arguments to take additional information into account when needed. Moreover, the forward pass and the conditions should accept the same set of keyword arguments.</p><pre><code class="language-julia hljs">function conditions_optim(x, y, z; method)
    ∇₂f = 2 .* (y .^ 2 .- x)
    return ∇₂f
end</code></pre><pre class="documenter-example-output"><code class="nohighlight hljs ansi">conditions_optim (generic function with 1 method)</code></pre><p>We now have all the ingredients to construct our implicit function.</p><pre><code class="language-julia hljs">implicit_optim = ImplicitFunction(forward_optim, conditions_optim)</code></pre><pre class="documenter-example-output"><code class="nohighlight hljs ansi">ImplicitFunction{typeof(Main.forward_optim), typeof(Main.conditions_optim), typeof(Krylov.gmres)}(Main.forward_optim, Main.conditions_optim, Krylov.gmres)</code></pre><p>And indeed, it behaves as it should when we call it:</p><pre><code class="language-julia hljs">x = rand(2)</code></pre><pre class="documenter-example-output"><code class="nohighlight hljs ansi">2-element Vector{Float64}:
 0.22442135286865494
 0.32672750942285145</code></pre><pre><code class="language-julia hljs">first(implicit_optim(x; method=LBFGS())) .^ 2</code></pre><pre class="documenter-example-output"><code class="nohighlight hljs ansi">2-element Vector{Float64}:
 0.22442135282677544
 0.3267275093803709</code></pre><p>Let&#39;s see what the explicit Jacobian looks like.</p><pre><code class="language-julia hljs">J = Diagonal(0.5 ./ sqrt.(x))</code></pre><pre class="documenter-example-output"><code class="nohighlight hljs ansi">2×2 LinearAlgebra.Diagonal{Float64, Vector{Float64}}:
 1.05545   ⋅ 
  ⋅       0.874736</code></pre><h2 id="Forward-mode-autodiff"><a class="docs-heading-anchor" href="#Forward-mode-autodiff">Forward mode autodiff</a><a id="Forward-mode-autodiff-1"></a><a class="docs-heading-anchor-permalink" href="#Forward-mode-autodiff" title="Permalink"></a></h2><pre><code class="language-julia hljs">ForwardDiff.jacobian(_x -&gt; first(implicit_optim(_x; method=LBFGS())), x)</code></pre><pre class="documenter-example-output"><code class="nohighlight hljs ansi">2×2 Matrix{Float64}:
  1.05545  -0.0
 -0.0       0.874736</code></pre><p>Unsurprisingly, the Jacobian is the identity. In this instance, we could use ForwardDiff.jl directly on the solver, but it returns the wrong result (not sure why).</p><pre><code class="language-julia hljs">ForwardDiff.jacobian(_x -&gt; mysqrt_optim(x; method=LBFGS()), x)</code></pre><pre class="documenter-example-output"><code class="nohighlight hljs ansi">2×2 Matrix{Float64}:
 0.0  0.0
 0.0  0.0</code></pre><h2 id="Reverse-mode-autodiff"><a class="docs-heading-anchor" href="#Reverse-mode-autodiff">Reverse mode autodiff</a><a id="Reverse-mode-autodiff-1"></a><a class="docs-heading-anchor-permalink" href="#Reverse-mode-autodiff" title="Permalink"></a></h2><pre><code class="language-julia hljs">Zygote.jacobian(_x -&gt; first(implicit_optim(_x; method=LBFGS())), x)[1]</code></pre><pre class="documenter-example-output"><code class="nohighlight hljs ansi">2×2 Matrix{Float64}:
 1.05545  0.0
 0.0      0.874736</code></pre><p>Again, the Jacobian is the identity. In this instance, we cannot use Zygote.jl directly on the solver (due to unsupported <code>try/catch</code> statements).</p><pre><code class="language-julia hljs">try
    Zygote.jacobian(_x -&gt; mysqrt_optim(x; method=LBFGS()), x)[1]
catch e
    e
end</code></pre><pre class="documenter-example-output"><code class="nohighlight hljs ansi">Zygote.CompileError(Tuple{typeof(Optim.perform_linesearch!), Optim.LBFGSState{Vector{Float64}, Vector{Vector{Float64}}, Vector{Vector{Float64}}, Float64, Vector{Float64}}, Optim.LBFGS{Nothing, LineSearches.InitialStatic{Float64}, LineSearches.HagerZhang{Float64, Base.RefValue{Bool}}, Optim.var&quot;#19#21&quot;}, Optim.ManifoldObjective{NLSolversBase.OnceDifferentiable{Float64, Vector{Float64}, Vector{Float64}}}}, ErrorException(&quot;try/catch is not supported.\nRefer to the Zygote documentation for fixes.\nhttps://fluxml.ai/Zygote.jl/latest/limitations\n&quot;))</code></pre><hr/><p><em>This page was generated using <a href="https://github.com/fredrikekre/Literate.jl">Literate.jl</a>.</em></p></article><nav class="docs-footer"><a class="docs-footer-prevpage" href="../0_basic/">« Basic use</a><a class="docs-footer-nextpage" href="../2_nonlinear_solve/">Nonlinear solve »</a><div class="flexbox-break"></div><p class="footer-message">Powered by <a href="https://github.com/JuliaDocs/Documenter.jl">Documenter.jl</a> and the <a href="https://julialang.org/">Julia Programming Language</a>.</p></nav></div><div class="modal" id="documenter-settings"><div class="modal-background"></div><div class="modal-card"><header class="modal-card-head"><p class="modal-card-title">Settings</p><button class="delete"></button></header><section class="modal-card-body"><p><label class="label">Theme</label><div class="select"><select id="documenter-themepicker"><option value="documenter-light">documenter-light</option><option value="documenter-dark">documenter-dark</option></select></div></p><hr/><p>This document was generated with <a href="https://github.com/JuliaDocs/Documenter.jl">Documenter.jl</a> version 0.27.24 on <span class="colophon-date" title="Wednesday 24 May 2023 08:43">Wednesday 24 May 2023</span>. Using Julia version 1.9.0.</p></section><footer class="modal-card-foot"></footer></div></div></div></body></html>
