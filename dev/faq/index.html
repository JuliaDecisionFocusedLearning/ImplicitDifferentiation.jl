<!DOCTYPE html>
<html lang="en"><head><meta charset="UTF-8"/><meta name="viewport" content="width=device-width, initial-scale=1.0"/><title>FAQ · ImplicitDifferentiation.jl</title><script data-outdated-warner src="../assets/warner.js"></script><link rel="canonical" href="https://gdalle.github.io/ImplicitDifferentiation.jl/faq/"/><link href="https://cdnjs.cloudflare.com/ajax/libs/lato-font/3.0.0/css/lato-font.min.css" rel="stylesheet" type="text/css"/><link href="https://cdnjs.cloudflare.com/ajax/libs/juliamono/0.045/juliamono.min.css" rel="stylesheet" type="text/css"/><link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.15.4/css/fontawesome.min.css" rel="stylesheet" type="text/css"/><link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.15.4/css/solid.min.css" rel="stylesheet" type="text/css"/><link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.15.4/css/brands.min.css" rel="stylesheet" type="text/css"/><link href="https://cdnjs.cloudflare.com/ajax/libs/KaTeX/0.13.24/katex.min.css" rel="stylesheet" type="text/css"/><script>documenterBaseURL=".."</script><script src="https://cdnjs.cloudflare.com/ajax/libs/require.js/2.3.6/require.min.js" data-main="../assets/documenter.js"></script><script src="../siteinfo.js"></script><script src="../../versions.js"></script><link class="docs-theme-link" rel="stylesheet" type="text/css" href="../assets/themes/documenter-dark.css" data-theme-name="documenter-dark" data-theme-primary-dark/><link class="docs-theme-link" rel="stylesheet" type="text/css" href="../assets/themes/documenter-light.css" data-theme-name="documenter-light" data-theme-primary/><script src="../assets/themeswap.js"></script></head><body><div id="documenter"><nav class="docs-sidebar"><div class="docs-package-name"><span class="docs-autofit"><a href="../">ImplicitDifferentiation.jl</a></span></div><form class="docs-search" action="../search/"><input class="docs-search-query" id="documenter-search-query" name="q" type="text" placeholder="Search docs"/></form><ul class="docs-menu"><li><a class="tocitem" href="../">Home</a></li><li class="is-active"><a class="tocitem" href>FAQ</a><ul class="internal"><li><a class="tocitem" href="#Supported-autodiff-backends"><span>Supported autodiff backends</span></a></li><li><a class="tocitem" href="#Input-and-output-types"><span>Input and output types</span></a></li><li><a class="tocitem" href="#Number-of-inputs-and-outputs"><span>Number of inputs and outputs</span></a></li><li><a class="tocitem" href="#Multiple-outputs-Derivatives-not-needed"><span>Multiple outputs | Derivatives not needed</span></a></li><li><a class="tocitem" href="#Modeling-tips"><span>Modeling tips</span></a></li></ul></li><li><span class="tocitem">Examples</span><ul><li><a class="tocitem" href="../examples/0_intro/">Introduction</a></li><li><a class="tocitem" href="../examples/1_basic/">Basic use cases</a></li><li><a class="tocitem" href="../examples/2_advanced/">Advanced use cases</a></li><li><a class="tocitem" href="../examples/3_tricks/">Tricks</a></li></ul></li><li><a class="tocitem" href="../api/">API reference</a></li></ul><div class="docs-version-selector field has-addons"><div class="control"><span class="docs-label button is-static is-size-7">Version</span></div><div class="docs-selector control is-expanded"><div class="select is-fullwidth is-size-7"><select id="documenter-version-selector"></select></div></div></div></nav><div class="docs-main"><header class="docs-navbar"><nav class="breadcrumb"><ul class="is-hidden-mobile"><li class="is-active"><a href>FAQ</a></li></ul><ul class="is-hidden-tablet"><li class="is-active"><a href>FAQ</a></li></ul></nav><div class="docs-right"><a class="docs-edit-link" href="https://github.com/gdalle/ImplicitDifferentiation.jl/blob/cb04988b1974191bc79a59d8bbec05a9b66545b6/docs/src/faq.md#" title="View on GitHub"><span class="docs-icon fab"></span><span class="docs-label is-hidden-touch">View on GitHub</span></a><a class="docs-settings-button fas fa-cog" id="documenter-settings-button" href="#" title="Settings"></a><a class="docs-sidebar-button fa fa-bars is-hidden-desktop" id="documenter-sidebar-button" href="#"></a></div></header><article class="content" id="documenter-page"><h1 id="Frequently-Asked-Questions"><a class="docs-heading-anchor" href="#Frequently-Asked-Questions">Frequently Asked Questions</a><a id="Frequently-Asked-Questions-1"></a><a class="docs-heading-anchor-permalink" href="#Frequently-Asked-Questions" title="Permalink"></a></h1><h2 id="Supported-autodiff-backends"><a class="docs-heading-anchor" href="#Supported-autodiff-backends">Supported autodiff backends</a><a id="Supported-autodiff-backends-1"></a><a class="docs-heading-anchor-permalink" href="#Supported-autodiff-backends" title="Permalink"></a></h2><p>To differentiate an <code>ImplicitFunction</code>, the following backends are supported.</p><table><tr><th style="text-align: right">Backend</th><th style="text-align: right">Forward mode</th><th style="text-align: right">Reverse mode</th></tr><tr><td style="text-align: right"><a href="https://github.com/JuliaDiff/ForwardDiff.jl">ForwardDiff.jl</a></td><td style="text-align: right">yes</td><td style="text-align: right">-</td></tr><tr><td style="text-align: right"><a href="https://github.com/JuliaDiff/ChainRules.jl">ChainRules.jl</a>-compatible</td><td style="text-align: right">yes</td><td style="text-align: right">soon</td></tr><tr><td style="text-align: right"><a href="https://github.com/EnzymeAD/Enzyme.jl">Enzyme.jl</a></td><td style="text-align: right">someday</td><td style="text-align: right">someday</td></tr></table><p>By default, the conditions are differentiated with the same backend as the <code>ImplicitFunction</code> that contains them. However, this can be switched to any backend compatible with <a href="https://github.com/JuliaDiff/AbstractDifferentiation.jl">AbstractDifferentiation.jl</a> (i.e. a subtype of <code>AD.AbstractBackend</code>). You can specify it with the <code>conditions_backend</code> keyword argument when constructing an <code>ImplicitFunction</code>.</p><div class="admonition is-warning"><header class="admonition-header">Warning</header><div class="admonition-body"><p>At the moment, <code>conditions_backend</code> can only be <code>nothing</code> or <code>AD.ForwardDiffBackend()</code>. We are investigating why the other backends fail.</p></div></div><h2 id="Input-and-output-types"><a class="docs-heading-anchor" href="#Input-and-output-types">Input and output types</a><a id="Input-and-output-types-1"></a><a class="docs-heading-anchor-permalink" href="#Input-and-output-types" title="Permalink"></a></h2><h3 id="Arrays"><a class="docs-heading-anchor" href="#Arrays">Arrays</a><a id="Arrays-1"></a><a class="docs-heading-anchor-permalink" href="#Arrays" title="Permalink"></a></h3><p>Functions that eat or spit out arbitrary arrays are supported, as long as the forward mapping <em>and</em> conditions return arrays of the same size.</p><p>If the output is a small array (say, less than 100 elements), consider using <a href="https://github.com/JuliaArrays/StaticArrays.jl">StaticArrays.jl</a> for increased performance.</p><h3 id="Scalars"><a class="docs-heading-anchor" href="#Scalars">Scalars</a><a id="Scalars-1"></a><a class="docs-heading-anchor-permalink" href="#Scalars" title="Permalink"></a></h3><p>Functions that eat or spit out a single number are not supported. The forward mapping <em>and</em> conditions need arrays: instead of returning <code>val</code> you should return <code>[val]</code> (a 1-element <code>Vector</code>). Or better yet, wrap it in a static vector: <code>SVector(val)</code>.</p><h3 id="Sparse-arrays"><a class="docs-heading-anchor" href="#Sparse-arrays">Sparse arrays</a><a id="Sparse-arrays-1"></a><a class="docs-heading-anchor-permalink" href="#Sparse-arrays" title="Permalink"></a></h3><div class="admonition is-danger"><header class="admonition-header">Danger</header><div class="admonition-body"><p>Sparse arrays are not supported and might give incorrect values or <code>NaN</code>s!</p></div></div><h2 id="Number-of-inputs-and-outputs"><a class="docs-heading-anchor" href="#Number-of-inputs-and-outputs">Number of inputs and outputs</a><a id="Number-of-inputs-and-outputs-1"></a><a class="docs-heading-anchor-permalink" href="#Number-of-inputs-and-outputs" title="Permalink"></a></h2><p>Most of the documentation is written for the simple case where the forward mapping is <code>x -&gt; y</code>, i.e. one input and one output. What can you do to handle multiple inputs or outputs? Well, it depends whether you want their derivatives or not.</p><table><tr><th style="text-align: right"></th><th style="text-align: right">Derivatives needed</th><th style="text-align: right">Derivatives not needed</th></tr><tr><td style="text-align: right"><strong>Multiple inputs</strong></td><td style="text-align: right">Make <code>x</code> a <code>ComponentVector</code></td><td style="text-align: right">Supply <code>args</code> and <code>kwargs</code> to <code>forward</code></td></tr><tr><td style="text-align: right"><strong>Multiple outputs</strong></td><td style="text-align: right">Make <code>y</code> and <code>c</code> two <code>ComponentVector</code>s</td><td style="text-align: right">Let <code>forward</code> return a byproduct</td></tr></table><p>We now detail each of these options.</p><h3 id="Multiple-inputs-or-outputs-Derivatives-needed"><a class="docs-heading-anchor" href="#Multiple-inputs-or-outputs-Derivatives-needed">Multiple inputs or outputs | Derivatives needed</a><a id="Multiple-inputs-or-outputs-Derivatives-needed-1"></a><a class="docs-heading-anchor-permalink" href="#Multiple-inputs-or-outputs-Derivatives-needed" title="Permalink"></a></h3><p>Say your forward mapping takes multiple input arrays and returns multiple output arrays, such that you want derivatives for all of them.</p><p>The trick is to leverage <a href="https://github.com/jonniedie/ComponentArrays.jl">ComponentArrays.jl</a> to wrap all the inputs inside a single a <code>ComponentVector</code>, and do the same for all the outputs. See the examples for a demonstration.</p><div class="admonition is-warning"><header class="admonition-header">Warning</header><div class="admonition-body"><p>You may run into issues trying to differentiate through the <code>ComponentVector</code> constructor. For instance, Zygote.jl will throw <code>ERROR: Mutating arrays is not supported</code>. Check out <a href="https://github.com/gdalle/ImplicitDifferentiation.jl/issues/67">this issue</a> for a dirty workaround involving custom chain rules for the constructor.</p></div></div><h3 id="Multiple-inputs-Derivatives-not-needed"><a class="docs-heading-anchor" href="#Multiple-inputs-Derivatives-not-needed">Multiple inputs | Derivatives not needed</a><a id="Multiple-inputs-Derivatives-not-needed-1"></a><a class="docs-heading-anchor-permalink" href="#Multiple-inputs-Derivatives-not-needed" title="Permalink"></a></h3><p>If your forward mapping (or conditions) takes multiple inputs but you don&#39;t care about derivatives, then you can add further positional and keyword arguments beyond <code>x</code>. It is important to make sure that the forward mapping and conditions accept the same set of arguments, even if each of these functions only uses a subset of them.</p><pre><code class="language-julia hljs">forward(x, arg1, arg2; kwarg1, kwarg2) = y
conditions(x, arg1, arg2; kwarg1, kwarg2) = c</code></pre><p>All of the positional and keyword arguments apart from <code>x</code> will get zero tangents during differentiation of the implicit function.</p><h2 id="Multiple-outputs-Derivatives-not-needed"><a class="docs-heading-anchor" href="#Multiple-outputs-Derivatives-not-needed">Multiple outputs | Derivatives not needed</a><a id="Multiple-outputs-Derivatives-not-needed-1"></a><a class="docs-heading-anchor-permalink" href="#Multiple-outputs-Derivatives-not-needed" title="Permalink"></a></h2><p>The last and most tricky situation is when your forward mapping returns multiple outputs, but you only care about some of their derivatives. Then, you need to group the objects you don&#39;t want to differentiate into a &quot;byproduct&quot; <code>z</code>, returned alongside the actual output <code>y</code>. This way, derivatives of <code>z</code> will not be computed: the byproduct is considered constant during differentiation.</p><p>The signatures of your functions will need to be be slightly different from the previous cases:</p><pre><code class="language-julia hljs">forward(x, arg1, arg2; kwarg1, kwarg2) = (y, z)
conditions(x, y, z, arg1, arg2; kwarg1, kwarg2) =  c</code></pre><p>See the examples for a demonstration.</p><p>This is mainly useful when the solution procedure creates objects such as Jacobians, which we want to reuse when computing or differentiating the conditions. In that case, you may want to write the conditions differentiation rules yourself. A more advanced application is given by <a href="https://github.com/gdalle/DifferentiableFrankWolfe.jl">DifferentiableFrankWolfe.jl</a>.</p><h2 id="Modeling-tips"><a class="docs-heading-anchor" href="#Modeling-tips">Modeling tips</a><a id="Modeling-tips-1"></a><a class="docs-heading-anchor-permalink" href="#Modeling-tips" title="Permalink"></a></h2><h3 id="Writing-conditions"><a class="docs-heading-anchor" href="#Writing-conditions">Writing conditions</a><a id="Writing-conditions-1"></a><a class="docs-heading-anchor-permalink" href="#Writing-conditions" title="Permalink"></a></h3><p>We recommend that the conditions themselves do not involve calls to autodiff, even when they describe a gradient. Otherwise, you will need to make sure that nested autodiff works well in your case. For instance, if you&#39;re differentiating your implicit function (and your conditions) in reverse mode with Zygote.jl, you may want to use ForwardDiff.jl mode to compute gradients inside the conditions.</p><h3 id="Dealing-with-constraints"><a class="docs-heading-anchor" href="#Dealing-with-constraints">Dealing with constraints</a><a id="Dealing-with-constraints-1"></a><a class="docs-heading-anchor-permalink" href="#Dealing-with-constraints" title="Permalink"></a></h3><p>To express constrained optimization problems as implicit functions, you might need differentiable projections or proximal operators to write the optimality conditions. See <a href="https://arxiv.org/abs/2105.15183"><em>Efficient and modular implicit differentiation</em></a> for precise formulations.</p><p>In case these operators are too complicated to code them yourself, here are a few places you can look:</p><ul><li><a href="https://github.com/matbesancon/MathOptSetDistances.jl">MathOptSetDistances.jl</a></li><li><a href="https://github.com/JuliaFirstOrder/ProximalOperators.jl">ProximalOperators.jl</a></li></ul><p>An alternative is differentiating through the KKT conditions, which is exactly what <a href="https://github.com/jump-dev/DiffOpt.jl">DiffOpt.jl</a> does for JuMP models.</p></article><nav class="docs-footer"><a class="docs-footer-prevpage" href="../">« Home</a><a class="docs-footer-nextpage" href="../examples/0_intro/">Introduction »</a><div class="flexbox-break"></div><p class="footer-message">Powered by <a href="https://github.com/JuliaDocs/Documenter.jl">Documenter.jl</a> and the <a href="https://julialang.org/">Julia Programming Language</a>.</p></nav></div><div class="modal" id="documenter-settings"><div class="modal-background"></div><div class="modal-card"><header class="modal-card-head"><p class="modal-card-title">Settings</p><button class="delete"></button></header><section class="modal-card-body"><p><label class="label">Theme</label><div class="select"><select id="documenter-themepicker"><option value="documenter-light">documenter-light</option><option value="documenter-dark">documenter-dark</option></select></div></p><hr/><p>This document was generated with <a href="https://github.com/JuliaDocs/Documenter.jl">Documenter.jl</a> version 0.27.25 on <span class="colophon-date" title="Wednesday 9 August 2023 22:45">Wednesday 9 August 2023</span>. Using Julia version 1.9.2.</p></section><footer class="modal-card-foot"></footer></div></div></div></body></html>
